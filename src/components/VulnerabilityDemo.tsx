// src/components/VulnerabilityDemo.tsx - Versi√≥n CTF en Espa√±ol
import React, { useState, useContext } from 'react';
import { AuthContext } from '../App';
import { makeDirectRequest, createFakeToken } from '../services/api';

const VulnerabilityDemo: React.FC = () => {
  const { user } = useContext(AuthContext);
  const [results, setResults] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [activeTest, setActiveTest] = useState<string>('');

  const addResult = (title: string, data: any, status: 'success' | 'failure' | 'discovery' = 'discovery') => {
    setResults(prev => [...prev, {
      id: Date.now(),
      title,
      data,
      status,
      timestamp: new Date().toLocaleTimeString()
    }]);
  };

  // Test de reconocimiento
  const runReconnaissance = async () => {
    setActiveTest('recon');
    setLoading(true);
    
    try {
      addResult('üîç Iniciando Fase de Reconocimiento', {
        objetivo: 'Sistema de Perfiles de Empleados',
        usuario_actual: user?.username,
        id_usuario: user?.id,
        rol: user?.role
      });

      // Enumerar perfiles
      for (let i = 1; i <= 6; i++) {
        try {
          const userData = await makeDirectRequest('GET', `/users/${i}`);
          addResult(
            `Descubrimiento de Perfil - Empleado #${i}`,
            {
              encontrado: true,
              nombre_usuario: userData.username,
              rol: userData.role,
              nivel_acceso: i !== user?.id ? 'no_autorizado' : 'autorizado',
              datos_sensibles: userData.profile ? 'expuestos' : 'ninguno'
            },
            'discovery'
          );
        } catch (error) {
          addResult(`Escaneo de Perfil - ID ${i}`, { 
            encontrado: false, 
            error: 'no_encontrado' 
          }, 'failure');
        }
        
        // Delay para simular reconocimiento realista
        await new Promise(resolve => setTimeout(resolve, 200));
      }

    } finally {
      setLoading(false);
      setActiveTest('');
    }
  };

  // Test de escalada de privilegios
  const runPrivilegeTest = async () => {
    setActiveTest('privilege');
    setLoading(true);
    
    try {
      addResult('üöÄ Probando L√≠mites de Privilegios', {
        rol_actual: user?.role,
        probando: 'acceso_administrativo'
      });

      // Test acceso administrativo
      try {
        const adminData = await makeDirectRequest('GET', '/admin/users');
        addResult(
          'Prueba de Acceso Administrativo',
          {
            resultado: 'exitoso',
            datos_obtenidos: adminData.length + ' registros de empleados',
            acceso_deberia_ser: 'solo_admin',
            acceso_real: 'sin_restricciones',
            nivel_riesgo: 'alto'
          },
          'discovery'
        );
      } catch (error: any) {
        addResult('Prueba de Acceso Administrativo', { 
          resultado: 'bloqueado',
          razon: error.message 
        }, 'failure');
      }

      // Test informaci√≥n del sistema
      try {
        const systemData = await makeDirectRequest('GET', '/system/info');
        addResult(
          'Acceso a Informaci√≥n del Sistema',
          {
            resultado: 'exitoso',
            datos_expuestos: Object.keys(systemData),
            exposicion_critica: systemData.secret_key ? 'secreto_jwt_expuesto' : 'ninguno',
            impacto: 'critico'
          },
          'discovery'
        );
      } catch (error: any) {
        addResult('Acceso a Informaci√≥n del Sistema', { 
          resultado: 'bloqueado',
          razon: error.message 
        }, 'failure');
      }

    } finally {
      setLoading(false);
      setActiveTest('');
    }
  };

  // Test de manipulaci√≥n avanzada
  const runAdvancedTests = async () => {
    setActiveTest('advanced');
    setLoading(true);
    
    try {
      addResult('üé≠ Investigaci√≥n de Seguridad Avanzada', {
        fase: 'analisis_y_manipulacion_de_tokens',
        investigador: user?.username
      });

      // An√°lisis de token
      const currentToken = localStorage.getItem('token');
      if (currentToken) {
        addResult(
          'An√°lisis de Token',
          {
            ubicacion_token: 'localStorage',
            vista_previa_token: currentToken.substring(0, 50) + '...',
            vulnerabilidad: 'almacenamiento_lado_cliente',
            potencial_explotacion: 'robo_token_via_xss'
          },
          'discovery'
        );

        // Demostrar creaci√≥n de token falso
        try {
          const fakeToken = createFakeToken({
            id: 999,
            username: 'investigador_seguridad',
            role: 'admin',
            email: 'investigador@example.com'
          });
          
          addResult(
            'Prueba de Falsificaci√≥n de Token',
            {
              rol_original: user?.role,
              token_falso_creado: true,
              rol_falsificado: 'admin',
              advertencia: 'Esto demuestra compromiso del secreto JWT',
              vista_previa_token: fakeToken.substring(0, 50) + '...'
            },
            'discovery'
          );
        } catch (error) {
          addResult('Prueba de Falsificaci√≥n de Token', { 
            resultado: 'fallido',
            razon: 'No se pudo falsificar el token' 
          }, 'failure');
        }
      }

      // Test modificaci√≥n de datos
      try {
        const targetUserId = user?.id === 1 ? 2 : 1;
        await makeDirectRequest('PUT', `/users/${targetUserId}`, {
          fullName: 'Modificado por Investigador de Seguridad',
          department: 'Pruebas de Seguridad'
        });
        
        addResult(
          'Modificaci√≥n de Datos Entre Usuarios',
          {
            usuario_modificado: targetUserId,
            tipo_modificacion: 'actualizacion_perfil',
            autorizacion: 'omitida',
            impacto: 'compromiso_integridad_datos'
          },
          'discovery'
        );
      } catch (error: any) {
        addResult('Prueba de Modificaci√≥n Entre Usuarios', { 
          resultado: 'bloqueado',
          razon: error.message 
        }, 'failure');
      }

    } finally {
      setLoading(false);
      setActiveTest('');
    }
  };

  const clearResults = () => setResults([]);

  const exportResults = () => {
    const reportData = {
      marca_tiempo: new Date().toISOString(),
      investigador: user?.username,
      sistema_objetivo: 'Portal de Gesti√≥n de Empleados',
      hallazgos: results
    };
    
    const blob = new Blob([JSON.stringify(reportData, null, 2)], {
      type: 'application/json'
    });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `reporte_investigacion_seguridad_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <div className="bg-white rounded-lg shadow-md p-6">
        <h1 className="text-2xl font-bold mb-4">üîß Laboratorio de Investigaci√≥n de Seguridad</h1>
        
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 p-4 rounded mb-6">
          <h3 className="font-bold text-blue-800 mb-2">üéØ Entorno de Investigaci√≥n</h3>
          <p className="text-blue-700 text-sm mb-2">
            Bienvenido al laboratorio de investigaci√≥n de seguridad. Este entorno te permite probar varios 
            escenarios de seguridad y explorar los l√≠mites del sistema en un ambiente controlado.
          </p>
          <div className="text-blue-600 text-xs">
            Investigador actual: <strong>{user?.username}</strong> | 
            Nivel de permisos: <strong>{user?.role}</strong> |
            Sesi√≥n de investigaci√≥n: Activa
          </div>
        </div>

        {/* Categor√≠as de Pruebas */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <button
            onClick={runReconnaissance}
            disabled={loading}
            className={`p-4 rounded-lg border-2 transition-all text-left ${
              activeTest === 'recon' 
                ? 'border-blue-500 bg-blue-50' 
                : 'border-gray-300 bg-white hover:border-blue-300'
            } disabled:opacity-50`}
          >
            <div className="flex items-center mb-2">
              <span className="text-2xl mr-2">üîç</span>
              <h3 className="font-bold text-blue-700">Reconocimiento</h3>
            </div>
            <p className="text-sm text-blue-600">
              Descubre l√≠mites del sistema y recursos accesibles
            </p>
            <div className="text-xs text-gray-500 mt-2">
              ‚Ä¢ Enumeraci√≥n de perfiles
              ‚Ä¢ Pruebas de l√≠mites de acceso
              ‚Ä¢ An√°lisis de exposici√≥n de datos
            </div>
          </button>

          <button
            onClick={runPrivilegeTest}
            disabled={loading}
            className={`p-4 rounded-lg border-2 transition-all text-left ${
              activeTest === 'privilege' 
                ? 'border-orange-500 bg-orange-50' 
                : 'border-gray-300 bg-white hover:border-orange-300'
            } disabled:opacity-50`}
          >
            <div className="flex items-center mb-2">
              <span className="text-2xl mr-2">üöÄ</span>
              <h3 className="font-bold text-orange-700">Pruebas de Privilegios</h3>
            </div>
            <p className="text-sm text-orange-600">
              Prueba acceso administrativo y exposici√≥n de informaci√≥n del sistema
            </p>
            <div className="text-xs text-gray-500 mt-2">
              ‚Ä¢ Acceso a interfaz administrativa
              ‚Ä¢ Exposici√≥n de configuraci√≥n del sistema
              ‚Ä¢ Rutas de escalada de privilegios
            </div>
          </button>

          <button
            onClick={runAdvancedTests}
            disabled={loading}
            className={`p-4 rounded-lg border-2 transition-all text-left ${
              activeTest === 'advanced' 
                ? 'border-purple-500 bg-purple-50' 
                : 'border-gray-300 bg-white hover:border-purple-300'
            } disabled:opacity-50`}
          >
            <div className="flex items-center mb-2">
              <span className="text-2xl mr-2">üé≠</span>
              <h3 className="font-bold text-purple-700">Investigaci√≥n Avanzada</h3>
            </div>
            <p className="text-sm text-purple-600">
              Manipulaci√≥n de tokens y explotaci√≥n profunda del sistema
            </p>
            <div className="text-xs text-gray-500 mt-2">
              ‚Ä¢ An√°lisis de tokens JWT
              ‚Ä¢ Intentos de falsificaci√≥n de tokens
              ‚Ä¢ Pruebas de modificaci√≥n de datos
            </div>
          </button>
        </div>

        {/* Panel de Resultados */}
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold">üìã Hallazgos de Investigaci√≥n</h2>
          <div className="flex space-x-2">
            <button
              onClick={exportResults}
              disabled={results.length === 0}
              className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors disabled:opacity-50"
            >
              üìÑ Exportar Reporte
            </button>
            <button
              onClick={clearResults}
              className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm transition-colors"
            >
              üóëÔ∏è Limpiar Resultados
            </button>
          </div>
        </div>

        {loading && (
          <div className="bg-blue-50 border border-blue-200 p-4 rounded mb-4">
            <div className="flex items-center">
              <div className="loading-spinner w-4 h-4 mr-3"></div>
              <span className="text-blue-700">
                Ejecutando pruebas de {activeTest === 'recon' ? 'reconocimiento' : 
                                     activeTest === 'privilege' ? 'privilegios' : 'investigaci√≥n avanzada'}... 
                Por favor espera.
              </span>
            </div>
          </div>
        )}

        <div className="space-y-3 max-h-96 overflow-y-auto">
          {results.map(result => (
            <div
              key={result.id}
              className={`p-4 rounded border ${
                result.status === 'discovery' 
                  ? 'bg-yellow-50 border-yellow-200' 
                  : result.status === 'success'
                    ? 'bg-green-50 border-green-200'
                    : 'bg-gray-50 border-gray-200'
              }`}
            >
              <div className="flex justify-between items-start mb-2">
                <h3 className={`font-bold ${
                  result.status === 'discovery' ? 'text-yellow-800' : 
                  result.status === 'success' ? 'text-green-800' : 'text-gray-800'
                }`}>
                  {result.status === 'discovery' ? 'üîç' : 
                   result.status === 'success' ? '‚úÖ' : '‚ùå'} {result.title}
                </h3>
                <span className="text-xs text-gray-500">{result.timestamp}</span>
              </div>
              <pre className="text-sm overflow-x-auto bg-white p-3 rounded border max-h-32">
                {JSON.stringify(result.data, null, 2)}
              </pre>
            </div>
          ))}
        </div>

        {results.length === 0 && (
          <div className="text-center text-gray-500 py-12">
            <div className="text-6xl mb-4">üî¨</div>
            <h3 className="text-xl font-medium mb-2">Listo para Investigaci√≥n de Seguridad</h3>
            <p className="text-gray-400">
              Selecciona una categor√≠a de prueba arriba para comenzar tu an√°lisis de seguridad
            </p>
          </div>
        )}

        {/* Consejos de Investigaci√≥n */}
        <div className="mt-6 bg-gradient-to-r from-indigo-50 to-blue-50 border border-indigo-200 rounded-lg p-4">
          <h3 className="font-bold text-indigo-800 mb-3">üí° Consejos de Metodolog√≠a de Investigaci√≥n</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <h4 className="font-semibold text-indigo-700 mb-2">üîç Enfoque de Investigaci√≥n:</h4>
              <ul className="text-indigo-600 space-y-1 text-xs">
                <li>‚Ä¢ Comienza con reconocimiento para mapear la superficie de ataque</li>
                <li>‚Ä¢ Prueba los l√≠mites de privilegios sistem√°ticamente</li>
                <li>‚Ä¢ Documenta todos los hallazgos con evidencia</li>
                <li>‚Ä¢ Busca patrones en el comportamiento del sistema</li>
              </ul>
            </div>
            <div>
              <h4 className="font-semibold text-indigo-700 mb-2">üõ†Ô∏è Pruebas Manuales:</h4>
              <ul className="text-indigo-600 space-y-1 text-xs">
                <li>‚Ä¢ Usa DevTools del navegador para an√°lisis m√°s profundo</li>
                <li>‚Ä¢ Modifica URLs y par√°metros manualmente</li>
                <li>‚Ä¢ Inspecciona peticiones y respuestas de red</li>
                <li>‚Ä¢ Prueba casos l√≠mite y condiciones de frontera</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};



export default VulnerabilityDemo;